name: å°åŒ—è¡—é ­è—äººç”³è«‹è‡ªå‹•åŒ–

on:
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      phase:
        description: 'åŸ·è¡Œ Phase (é è¨­: 3)'
        required: false
        default: '3'
        type: choice
        options:
        - '3'
        - '2'
  
  # Push è§¸ç™¼ (å…©å€‹åˆ†æ”¯éƒ½æ”¯æ´)
  push:
    branches: [ main, feature/login-issue-fix ]
    paths:
      - 'github-automation/**'
      - '.github/workflows/**'

jobs:
  street-artist-apply:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ðŸ è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ðŸ“¦ å®‰è£ç³»çµ±ç›¸ä¾å¥—ä»¶
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
        echo "âœ… xvfb å®‰è£å®Œæˆ"
    
    - name: ðŸ“š å®‰è£ Python å¥—ä»¶
      run: |
        cd github-automation
        pip install -r requirements.txt
        echo "âœ… Python å¥—ä»¶å®‰è£å®Œæˆ"
    
    - name: ðŸŽ­ å®‰è£ Playwright ç€è¦½å™¨
      run: |
        playwright install chromium
        playwright install-deps chromium
        echo "âœ… Playwright Chromium å®‰è£å®Œæˆ"
    
    - name: ðŸš€ åŸ·è¡Œè¡—é ­è—äººç”³è«‹ (xvfb)
      env:
        TAIPEI_USERNAME: ${{ secrets.TAIPEI_USERNAME }}
        TAIPEI_PASSWORD: ${{ secrets.TAIPEI_PASSWORD }}
        PHASE: ${{ github.event.inputs.phase || '3' }}
      run: |
        cd github-automation
        echo "ðŸŽ¯ é–‹å§‹åŸ·è¡Œ Phase $PHASE"
        echo "ðŸ–¥ï¸  ä½¿ç”¨ xvfb è™›æ“¬é¡¯ç¤ºå™¨"
        xvfb-run -a --server-args="-screen 0 1366x768x24" python main.py
    
    - name: ðŸ“¸ ä¸Šå‚³æˆªåœ–åˆ° Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-${{ github.run_number }}
        path: github-automation/screenshots/
        retention-days: 90
    
    - name: ðŸ“‹ ä¸Šå‚³åŸ·è¡Œæ—¥èªŒ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ github.run_number }}
        path: |
          github-automation/*.log
        retention-days: 30
        if-no-files-found: ignore
    
    - name: ðŸ“Š é¡¯ç¤ºåŸ·è¡Œæ‘˜è¦
      if: always()
      run: |
        echo "## ðŸŽ¯ åŸ·è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "- **åŸ·è¡Œæ™‚é–“**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Phase**: ${{ github.event.inputs.phase || '3' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¸ç™¼æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "github-automation/screenshots" ]; then
          screenshot_count=$(ls -1 github-automation/screenshots/*.png 2>/dev/null | wc -l)
          echo "- **æˆªåœ–æ•¸é‡**: ${screenshot_count} å¼µ" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **æˆªåœ–æ•¸é‡**: 0 å¼µ" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ è«‹åˆ° Artifacts å€åŸŸä¸‹è¼‰æˆªåœ–å’Œæ—¥èªŒæª”æ¡ˆ" >> $GITHUB_STEP_SUMMARY
