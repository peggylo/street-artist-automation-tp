# 瀏覽器自動化反檢測指南

## 🎯 目標與背景

台北通登入系統使用 reCAPTCHA v3 檢測機器人行為，直接使用 Playwright 自動化容易被識別並阻擋登入。本指南提供完整的反檢測策略，確保自動化程式能穩定通過人機驗證。

## 🏗️ 整體策略架構

### 核心理念
**模擬真實用戶的完整瀏覽歷程**，而非僅針對登入頁面進行自動化操作。

### 三階段防護
1. **環境偽裝**：使用臨時 Profile 避免自動化標識
2. **行為養成**：預先瀏覽相關網站建立真實軌跡  
3. **操作自然化**：模擬人類的點擊、輸入、移動行為

---

## 📂 Profile 管理策略

### 統一使用臨時 Profile 方案

**本機開發與 GitHub Actions 完全一致**

#### 為什麼選擇臨時 Profile？
- **環境一致性**：本機測試結果等同雲端執行結果
- **真實性**：每次都是「全新用戶」體驗，符合真實情境
- **乾淨性**：無殘留資料影響，問題容易重現
- **安全性**：不會洩漏個人瀏覽資料

#### Profile 生命週期
1. **程式啟動**：建立臨時資料夾 `/tmp/street-artist-profile-[隨機數字]/`
2. **執行期間**：所有瀏覽器資料儲存於此
3. **程式結束**：自動清理刪除資料夾

---

## 🎪 養軌跡策略

### 瀏覽路徑設計

**目標**：建立「準備申請街頭藝人」的真實用戶軌跡

#### 建議瀏覽順序
1. **台北市政府首頁** (taipei.gov.tw)
   - 停留 15-25 秒
   - 輕微滾動頁面

2. **市民服務專區**
   - 停留 20-30 秒  
   - 點擊 1-2 個相關連結

3. **線上申辦服務**
   - 停留 15-20 秒
   - 瀏覽申辦項目列表

4. **文化局相關頁面**（可選）
   - 停留 10-15 秒

#### 時間分配
- **總計時間**：2-3 分鐘
- **頁面間隔**：5-10 秒隨機延遲
- **考量因素**：平衡真實性與執行效率

---

## 🤖 反檢測技術

### 瀏覽器啟動參數

**移除自動化標識**
- 停用自動化控制特徵
- 模擬真實用戶代理
- 關閉開發者工具檢測

### 行為模擬技術

#### 登入階段（高強度模擬）
- **滑鼠移動**：模擬真實軌跡，避免直線移動
- **點擊行為**：隨機偏移點擊位置
- **文字輸入**：逐字輸入，隨機打字速度
- **操作間隔**：隨機延遲 100-300ms

#### 登入後階段（中強度模擬）  
- **基本延遲**：操作間隔 50-150ms
- **自然點擊**：點擊前短暫停留
- **表單填寫**：逐字輸入表演項目

---

## 🔄 錯誤處理與重試機制

### 重試策略

**被 reCAPTCHA 阻擋時的處理**
1. **完全重建**：刪除當前 Profile，建立全新環境
2. **重新養軌跡**：執行完整的瀏覽歷程
3. **延長等待**：增加操作間隔時間
4. **最大重試**：3 次，間隔 30 秒

### 失敗判斷標準
- 登入頁面出現「機器人驗證未通過」訊息
- 登入按鈕點擊後無反應超過 30 秒
- 頁面跳轉到錯誤或驗證頁面

---

## 🖥️ 開發環境配置

### 本機開發階段

#### Phase 1：有畫面除錯
- **瀏覽器模式**：headless=False
- **目的**：觀察每個步驟，確認流程正確
- **Profile**：臨時資料夾
- **養軌跡**：完整執行

#### Phase 2：無畫面測試  
- **瀏覽器模式**：headless=True（透過 config.py 控制）
- **目的**：模擬 GitHub Actions 環境
- **截圖機制**：維持現有密度，每個步驟自動截圖
- **養軌跡**：保持啟用（TRAJECTORY_BUILDING_ENABLED=True）
- **日誌增強**：詳細但適量的 log 輸出
- **驗證方式**：透過截圖確認任務完成狀況
- **環境**：直接在 macOS 測試，不使用 Docker

### GitHub Actions 部署

#### 環境特性
- **執行環境**：Ubuntu Linux
- **顯示方式**：xvfb 虛擬螢幕
- **Profile 位置**：/tmp/ 臨時目錄
- **網路環境**：固定 IP，可能被識別

#### 最佳化設定
- **預先安裝**：瀏覽器與相依套件
- **環境變數**：敏感資訊透過 Secrets 管理
- **執行時間**：控制在 10 分鐘內完成

---

## 📊 效果評估與調整

### 成功率指標
- **目標成功率**：85% 以上
- **評估週期**：每週執行 5-10 次測試
- **記錄內容**：成功/失敗原因、執行時間

### 策略調整原則
1. **成功率低於 70%**：增加養軌跡時間或頁面數量
2. **執行時間過長**：優化瀏覽路徑，減少不必要停留
3. **特定錯誤頻繁**：針對性調整反檢測參數

---

## 🔧 維護注意事項

### 定期檢查項目
- **網站結構變化**：台北市政府網站改版影響
- **reCAPTCHA 政策更新**：檢測機制升級
- **瀏覽器版本**：Playwright 與 Chromium 更新

### 應變策略
- **備用瀏覽路徑**：準備 2-3 套不同的養軌跡方案
- **參數調整**：根據成功率動態調整延遲時間
- **降級方案**：必要時回到手動申請

---

**版本**: v1.1 | **更新**: 2025-09-25 | **適用於**: Phase 2 無畫面測試開發

### Phase 2 重點決策記錄
- **架構選擇**：單一 main.py + config.py 控制切換（不複製檔案）
- **headless 模式**：使用 headless=True，不使用 xvfb
- **截圖策略**：維持現有密度，完整記錄每個步驟
- **養軌跡**：保持啟用，提升登入成功率
- **日誌增強**：適量詳細的 log 輸出，彌補無畫面限制
- **測試環境**：直接在 macOS 測試，Phase 3 再處理 Docker
